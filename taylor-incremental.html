<style>
#gameTime:before {
	content: "Total time played: ";
}
#gameTime {
	float: right;
}
#money:before {
	content: "Gold: ";
}
#money {
	margin-right: 1em;
}
#production:before {
	content: "Gaining ";
}
#production:after {
	content: " gold/s";
}
#buildings:before {
	content: "Buildings: ";
}
#buildings {
	margin-right: 1em;
}
#nextUpgrade:before {
	display: block;
	font-weight: bold;
	content: "Next upgrade:";
}
#nextUpgrade:after {
	display: block;
	content: "";
}
#pastUpgrades {
	margin-top: 1em;
}
.hidden {
	display: none;
}
</style>
<div id="gameTime"></div>
<div id="money"></div>
<div id="production"></div>
<div><span id="buildings"></span><button id="buyBuilding" onclick="buyBuilding()">Buy</button><button id="buyBuildingMax" class="hidden" onclick="buyBuildingMax()">Buy Max</button></div>
<div><span id="nextUpgrade"></span><button id="buyUpgrade" onclick="buyUpgrade()">Buy</button></div>
<div id="pastUpgrades"></div>
<script>
var money = 0;
var buildings = 1;
var upgrades = 0;
var lastUpdated = new Date().getTime();
var gameTime = 0;

function upgradeRate(i) {
	return 2 / (i+1);
}

function formatNumber(f) {
	if(f == 0) return "0";
	if(f >= 1e6) return f.toExponential(2);
	if(f >= 100) return f.toFixed(0);
	if(f >= 0.01) return (+f.toPrecision(3)).toString();
	return f.toPrecision(3);
}

function formatPercent(f) {
	if(f == 0) return "0%";
	if(f >= 1) return (f * 100).toFixed(0) + "%";
	if(f >= 0.01) return (+(f * 100).toFixed(2)).toString() + "%";
	return (f * 100).toPrecision(3) + "%"
}

function formatTime(f) {
	var parts = [];
	if(f >= 3600*24) parts.push(Math.floor(f / (3600*24))+"d");
	if(f >= 3600) parts.push((Math.floor(f / 3600)%24)+"h");
	if(f >= 60) parts.push((Math.floor(f / 60)%60)+"m");
	if(f >= 1) parts.push((Math.floor(f)%60)+"s");
	return parts.join(" ");
}

function upgradeText(i) {
	var rate = upgradeRate(i);
	var rateDisplay = formatPercent(rate);
	var totalDisplay = formatPercent(rate * buildings);
	return "Increase the production of buildings by "+rateDisplay+" for every building. ("+totalDisplay+")";
}

function upgradeName(i) {
	var sizes = ["Village", "Town", "City", "Kingdom", "Empire"];
	var animals = ["Cat", "Goat", "Pig", "Camel", "Chicken"];
	var moods = ["Pet", "Angry", "Tired", "Refugee", "Allied"];
	if(i < 6) return "Mining "+sizes[(i - 1) % 5];
	if(i < 31) return sizes[Math.floor((i-6) / 5)]+" of "+animals[(i - 6) % 5]+"s";
	if(i < 656) return animals[Math.floor((i-31) / 5) % 5]+" "+sizes[Math.floor((i-31) / 25) % 5]+" with "+moods[Math.floor((i-31) / 125) % 5]+" "+animals[(i - 30 + Math.floor((i-31) / 5)) % 5]+"s";
	return animals[Math.floor((i-31) / 5) % 5]+" "+sizes[Math.floor((i-31) / 25) % 5]+" with "+moods[Math.floor((i-31) / 125) % 5]+" "+animals[(i - 30 + Math.floor((i-31) / 25)) % 5]+"s "+"I".repeat(Math.floor((i - 31) / 625)+1);
}

var productionRate = buildings;
function refreshRate() {
	productionRate = buildings;
	for(var i = 1; i <= upgrades; i++) {
		var rate = upgradeRate(i);
		productionRate *= (1 + rate * buildings);
	}
}

function display(path, text) {
	document.querySelector(path).innerText = text;
}

setInterval(function() {
	var now = new Date().getTime();
	var gains = Math.floor((now - lastUpdated) * productionRate / 1000);
	money += gains;
	lastUpdated += gains * 1000 / productionRate;
	gameTime += gains / productionRate;

	display("#money", formatNumber(money));
	display("#gameTime", formatNumber(gameTime));

	if(money > buildingCost() * 100) {
		document.querySelector("#buyBuildingMax").className = null;
	}
}, 100);

function save() {
	localStorage.setItem("taylor-incremental", JSON.stringify({
		money: money,
		buildings: buildings,
		upgrades: upgrades,
		lastUpdated: lastUpdated,
		gameTime: gameTime
	}));
}

function loadSave() {
	var savegame = localStorage.getItem("taylor-incremental");
	if(savegame) {
		var data = JSON.parse(savegame);
		money = Math.max(+data.money, 0);
		buildings = Math.max(+data.buildings, 1);
		upgrades = Math.max(+data.upgrades, 0);
		if(+data.lastUpdated > 1546300800000) lastUpdated = +data.lastUpdated;
		gameTime = Math.max(+data.gameTime, 0);
		refreshRate();
	}
}

function redraw() {
	display("#buildings", formatNumber(buildings));
	display("#buyBuilding", "Buy for "+formatNumber(buildingCost())+" gold");
	display("#production", formatNumber(productionRate));
	display("#nextUpgrade", upgradeName(upgrades+1)+": "+upgradeText(upgrades+1));
	display("#buyUpgrade", "Buy for "+formatNumber(upgradeCost())+" gold");

	var upgradeBoxes = document.querySelectorAll("#pastUpgrades > div");
	for(var i = 1; i <= upgrades; i++) {
		var box = upgradeBoxes[i - 1];
		if(typeof box === "undefined") {
			box = document.createElement("div");
			document.getElementById("pastUpgrades").appendChild(box);
		}
		box.innerText = upgradeName(i)+": "+upgradeText(i);
	}
}

function buildingCost() {
	return Math.floor(10 * Math.pow(1.3, buildings - 5));
}

function upgradeCost() {
	return Math.floor(Math.pow(100, upgrades + 1));
}

function buyBuilding() {
	var cost = buildingCost();
	if(money >= cost) {
		money -= cost;
		buildings++;
		refreshRate();
		redraw();
		save();
	}
}

function buyBuildingMax() {
	var boughtValue = (10 * Math.pow(1.3, buildings - 5)) / 0.3;
	var canBuyTo = Math.floor(Math.log((money + boughtValue) / 10 * 0.3) / Math.log(1.3) + 5);
	var buyPrice = Math.floor((10 * Math.pow(1.3, canBuyTo - 5)) / 0.3 - boughtValue);
	if(canBuyTo > buildings) {
		money -= buyPrice;
		buildings = canBuyTo;
		refreshRate();
		redraw();
		save();
	}
	document.querySelector("#buyBuildingMax").className = "hidden";
}

function buyUpgrade() {
	var cost = upgradeCost();
	if(money >= cost) {
		money -= cost;
		upgrades++;
		refreshRate();
		redraw();
		save();
	}
}

loadSave();
redraw();
</script>

